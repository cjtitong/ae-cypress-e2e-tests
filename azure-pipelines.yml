trigger:
  branches:
    include:
      - main

variables:
  CYPRESS_baseUrl: 'https://automationexercise.com'

jobs:
  - job: SelfHosted
    displayName: "Run on self-hosted agent"
    pool:
      name: Default
      demands:
        - agent.name -equals AgentToken
    steps:
      - checkout: self

      - task: NodeTool@0
        inputs:
          versionSpec: '20.x'
        displayName: 'Setup Node.js'

      - script: |
          npm ci
          if [ ! -d "results/mochawesome" ]; then mkdir -p results/mochawesome; fi
          npm run test:ci
        displayName: 'Install dependencies & run Cypress tests'

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: 'results'
          artifactName: 'cypress-results'

  - job: HostedFallback
    displayName: "Run on Microsoft-hosted agent if self-hosted fails"
    dependsOn: SelfHosted
    condition: failed()
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self

      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
        displayName: 'Setup Node.js'

      - script: |
          npm ci
          mkdir -p results/mochawesome
          npm run test:ci
        displayName: 'Install dependencies & run Cypress tests'

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: 'results'
          artifactName: 'cypress-results'
